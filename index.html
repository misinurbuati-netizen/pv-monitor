<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV-OS 4.5 è¥¿åŒ—åŸºåœ°æ™ºæ…§ç›‘æ§ç³»ç»Ÿ (å…¨åŠŸèƒ½é›†æˆç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg-dark: #06090f; --card-bg: #111621; --primary-blue: #00f2ff;
            --accent-green: #2ecc71; --warning-orange: #f39c12; 
            --sub-health: #9b59b6; --danger-red: #e74c3c;
            --border-color: #1e2736; --text-main: #e2e8f0;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'PingFang SC', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { padding: 12px 25px; background: #0f172a; border-bottom: 2px solid var(--primary-blue); display: flex; justify-content: space-between; align-items: center; }
        main { display: grid; grid-template-columns: 350px 1fr 400px; gap: 15px; padding: 15px; flex: 1; overflow: hidden; }
        .column { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .card-title { color: var(--primary-blue); font-size: 15px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        
        /* æ°”è±¡å¡ç‰‡æ ·å¼ */
        .weather-box { background: linear-gradient(135deg, #1e293b, #0f172a); padding: 12px; border-radius: 8px; border: 1px solid #334155; }
        .temp-large { font-size: 32px; color: var(--primary-blue); font-weight: bold; }

        /* é¢æ¿çŸ©é˜µæ ·å¼ */
        .grid-wrapper { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; overflow-y: auto; }
        .panel { aspect-ratio: 1; border-radius: 4px; font-size: 9px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: rgba(255,255,255,0.05); border: 1px solid #2d3748; transition: 0.2s; }
        .p-normal { border-color: var(--primary-blue); color: var(--primary-blue); }
        .p-dust { border-color: var(--warning-orange); color: var(--warning-orange); background: rgba(243,156,18,0.15); }
        .p-low { border-color: var(--sub-health); color: var(--sub-health); background: rgba(155,89,182,0.15); }
        .p-break { border-color: var(--danger-red); color: var(--danger-red); animation: pulse-blink 1.2s infinite; }
        
        @keyframes pulse-blink { 50% { background: rgba(231, 76, 60, 0.4); border-color: #fff; } }

        /* åº•éƒ¨æ—¥å¿—å’Œå›¾è¡¨ */
        .log-area { flex: 1; overflow-y: auto; font-size: 11px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 6px; border-bottom: 1px solid rgba(255,255,255,0.02); }
        #alert-popup { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); width: 80%; max-width: 500px; padding: 20px; border-radius: 12px; background: rgba(231, 76, 60, 0.98); color: white; display: none; z-index: 10000; border: 3px solid #fff; text-align: center; }
    </style>
</head>
<body>

<div id="alert-popup"></div>

<header>
    <div style="font-size:18px; font-weight:bold; color:var(--primary-blue)">PV-OS 4.5 è¥¿åŒ—åŸºåœ°æ™ºæ…§ç›‘æ§ä¸­æ¢</div>
    <div id="clock" style="font-family:monospace; color:var(--primary-blue)"></div>
</header>

<main>
    <div class="column">
        <div class="card">
            <div class="card-title">è¥¿åŒ—ç«™è”ç½‘æ°”è±¡ (çœŸå®API)</div>
            <div class="weather-box">
                <div style="display:flex; justify-content:space-between">
                    <span id="w-city" style="color:var(--primary-blue)">å®šä½ä¸­...</span>
                    <span id="w-cond" style="color:var(--warning-orange)">--</span>
                </div>
                <div style="margin:8px 0">
                    <span class="temp-large" id="w-temp">--Â°C</span>
                    <span style="font-size:12px; color:#94a3b8; margin-left:10px">æ¹¿åº¦: <span id="w-hum">--</span>%</span>
                </div>
                <div id="w-tips" style="font-size:11px; border-top:1px solid #334155; padding-top:5px; color:#94a3b8">æ­£åœ¨æŠ“å–é…’æ³‰ç«™æ•°æ®...</div>
            </div>
        </div>
        <div class="card" style="flex:1">
            <div class="card-title">è¿ç»´å•ä½çŠ¶æ€</div>
            <div style="padding:10px; background:rgba(0,242,255,0.05); border-radius:6px; margin-bottom:10px">
                <b>BOT-A1 å±¥å¸¦æ¸…æ‰«è½¦</b><br>
                çŠ¶æ€ï¼š<span id="bot-msg" style="color:var(--accent-green)">åŸºç«™å¾…å‘½</span>
            </div>
            <div style="padding:10px; background:rgba(155,89,182,0.05); border-radius:6px">
                <b>UAV-X4 å·¡æ£€æ— äººæœº</b><br>
                çŠ¶æ€ï¼š<span style="color:var(--primary-blue)">AIå·¡è§†ä¸­...</span>
            </div>
            <div style="margin-top:auto; padding:12px; background:rgba(46,204,113,0.1); border-radius:8px">
                <div style="font-size:11px; color:#94a3b8">å…¨åœºå®æ—¶æ€»åŠŸç‡</div>
                <div id="total-p" style="font-size:24px; font-weight:bold; color:var(--accent-green)">0.00 kW</div>
            </div>
        </div>
    </div>

    <div class="card" style="flex:1">
        <div class="card-title">æ¿é˜µå¥åº·æ‹“æ‰‘ (å››çº§è¯Šæ–­)</div>
        <div style="display:flex; gap:12px; font-size:11px; margin-bottom:10px; opacity:0.8">
            <span><i style="color:var(--primary-blue)">â—</i> æ­£å¸¸</span>
            <span><i style="color:var(--warning-orange)">â—</i> ç§¯ç°</span>
            <span><i style="color:var(--sub-health)">â—</i> å¼‚å¸¸</span>
            <span><i style="color:var(--danger-red)">â—</i> æŸå</span>
        </div>
        <div class="grid-wrapper" id="panelGrid"></div>
    </div>

    <div class="column">
        <div class="card" style="height:220px">
            <div class="card-title">å¹¶ç½‘åŠŸç‡æ³¢åŠ¨æ›²çº¿ (ä»¿çœŸ)</div>
            <canvas id="powerChart"></canvas>
        </div>
        <div class="card" style="flex:1">
            <div class="card-title">å®æ—¶è¿ç»´æµæ°´æ—¥å¿—</div>
            <div class="log-area"><table><tbody id="logBody"></tbody></table></div>
        </div>
    </div>
</main>

<script>
    // --- é…ç½®åŒº ---
    const AMAP_KEY = '16b326717f33f898a349af7d93b703d9';
    const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC = "testtopic/status";
    const KEYS = ['SCT316557Te9lbWvEB1wXbnOG91YgQKlFH', 'SCT316562TrO4WoFFGxdxQWbQ89I9hTFHJ'];

    let globalRad = 0; 
    let powerChart;
    const historyData = [];
    const historyLabels = [];

    // --- åˆå§‹åŒ– UI ---
    for (let i = 1; i <= 100; i++) {
        const p = document.createElement('div');
        const id = 'P-' + String(i).padStart(3, '0');
        p.className = 'panel p-normal';
        p.id = id;
        p.innerHTML = `<span>${id}</span><span class="p-val">--W</span>`;
        panelGrid.appendChild(p);
    }

    function addLog(obj, msg) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="color:#718096; width:70px">${new Date().toLocaleTimeString()}</td><td style="color:var(--primary-blue); width:50px">${obj}</td><td>${msg}</td>`;
        logBody.insertBefore(tr, logBody.firstChild);
    }

    // --- å›¾è¡¨åˆå§‹åŒ– ---
    function initChart() {
        const ctx = document.getElementById('powerChart').getContext('2d');
        powerChart = new Chart(ctx, {
            type: 'line',
            data: { labels: historyLabels, datasets: [{ label: 'åŠŸç‡ kW', data: historyData, borderColor: '#00f2ff', tension: 0.4, fill: true, backgroundColor: 'rgba(0,242,255,0.05)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.05)' } } }, plugins: { legend: { display: false } } }
        });
    }

    // --- è”ç½‘æ•°æ®é€»è¾‘ ---
    async function fetchWeather() {
        try {
            const res = await fetch(`https://restapi.amap.com/v3/weather/weatherInfo?city=620900&key=${AMAP_KEY}`);
            const data = await res.json();
            if(data.lives) {
                const live = data.lives[0];
                document.getElementById('w-city').innerText = `é…’æ³‰ç«™ï¼š${live.city}`;
                document.getElementById('w-cond').innerText = live.weather;
                document.getElementById('w-temp').innerText = live.temperature + "Â°C";
                document.getElementById('w-hum').innerText = live.humidity;
                document.getElementById('w-tips').innerText = live.weather.includes('å°˜') ? "ğŸš¨ ç›‘æµ‹åˆ°æ‰¬æ²™ï¼šç³»ç»Ÿè½¬å…¥å¼ºåŒ–æ¸…æ‰«æ¨¡å¼ã€‚" : "âœ… æ°”è±¡è‰¯å¥½ï¼šå»ºè®®æ‰§è¡Œæ— äººæœºç²¾ç»†åŒ–å·¡æ£€ã€‚";
            }
            // è¾å°„ API
            const rRes = await fetch('https://api.open-meteo.com/v1/forecast?latitude=39.74&longitude=98.50&current=shortwave_radiation');
            const rData = await rRes.json();
            globalRad = rData.current.shortwave_radiation;
            document.getElementById('rad').innerText = globalRad;
            updatePowerVisuals();
        } catch(e) { console.error("æ•°æ®æºåŒæ­¥å¤±è´¥"); }
    }

    function updatePowerVisuals() {
        let totalW = 0;
        document.querySelectorAll('.panel').forEach(el => {
            let p = 0;
            if(el.classList.contains('p-normal')) p = globalRad * 0.45 + (Math.random()*6-3);
            else if(el.classList.contains('p-dust')) p = globalRad * 0.3;
            else if(el.classList.contains('p-low')) p = globalRad * 0.15;
            else p = Math.random()*5;

            p = Math.max(0, p);
            el.querySelector('.p-val').innerText = Math.floor(p) + 'W';
            totalW += p;
        });
        const kw = (totalW/1000).toFixed(2);
        document.getElementById('total-p').innerText = kw + " kW";
        document.getElementById('sim-p').innerText = kw;
        
        // æ›´æ–°å›¾è¡¨
        historyLabels.push(""); historyData.push(kw);
        if(historyData.length > 20) { historyData.shift(); historyLabels.shift(); }
        powerChart.update();
    }

    // --- MQTT é€šä¿¡é€»è¾‘ ---
    const client = mqtt.connect(MQTT_BROKER);
    client.on('connect', () => {
        addLog('ç³»ç»Ÿ', 'MQTT é“¾è·¯å·²æ¿€æ´»ï¼Œæ¥æ”¶æœºè½½ç«¯å®æ—¶è¯Šæ–­...');
        client.subscribe(TOPIC);
    });

    client.on('message', (topic, message) => {
        const msg = message.toString();
        addLog('æ— äººæœº', `å®æ—¶æ£€æµ‹æŠ¥å‘Šï¼š${msg}`);
        // æ¼”ç¤ºç”¨å›ºå®š ID
        handleCommand("P-015", msg);
    });

    function handleCommand(id, status) {
        const el = document.getElementById(id);
        if(!el) return;

        if(status === 'dirty') {
            el.className = 'panel p-dust';
            document.getElementById('bot-msg').innerText = `å‰å¾€æ¸…æ‰« ${id}`;
            addLog('è°ƒåº¦', `å·²æŒ‡æ´¾ BOT-A1 å‰å¾€ä¿®å¤ç§¯ç°æ¿å— ${id}`);
        } else if(status === 'cracked') {
            el.className = 'panel p-break';
            triggerAlert(id);
        } else if(status === 'panel') {
            el.className = 'panel p-normal';
            addLog('ç³»ç»Ÿ', `æ¿å— ${id} æ¢å¤å¥åº·çŠ¶æ€`);
        }
    }

    function triggerAlert(id) {
        const pop = document.getElementById('alert-popup');
        pop.innerHTML = `ğŸš¨ <b>æ£€æµ‹åˆ°ä¸¥é‡ç‰©ç†æŸå (#${id})</b><br>å¾®ä¿¡åŒäººè”åŠ¨å‘Šè­¦å·²ä¸‹å‘è‡³è¿ç»´ç»„å‘˜ã€‚`;
        pop.style.display = 'block';
        setTimeout(() => pop.style.display = 'none', 6000);
        
        KEYS.forEach(key => {
            fetch(`https://sctapi.ftqq.com/${key}.send?title=æŸåå‘Šè­¦&desp=æ¿å—${id}æ£€æµ‹åˆ°ç¢è£‚`, { mode:'no-cors' });
        });
    }

    // å¯åŠ¨
    initChart();
    fetchWeather();
    setInterval(fetchWeather, 30000);
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

</script>
</body>
</html>