
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV-OS 4.0 è¥¿åŒ—åŸºåœ°æ™ºæ…§ç›‘æ§ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #06090f;
            --card-bg: #111621;
            --primary-blue: #00f2ff;
            --accent-green: #2ecc71;
            --warning-orange: #f39c12; /* ç§¯ç° */
            --sub-health: #9b59b6;     /* å¼‚å¸¸/äºšå¥åº· */
            --danger-red: #e74c3c;     /* æŸå */
            --border-color: #1e2736;
            --text-main: #e2e8f0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'PingFang SC', sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        #alert-popup {
            position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 550px; padding: 25px; border-radius: 12px;
            background: rgba(231, 76, 60, 0.98); color: white;
            font-weight: bold; text-align: center;
            display: none; z-index: 10000; border: 3px solid #fff;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); line-height: 1.6;
        }

        header {
            padding: 12px 25px; background: #0f172a; border-bottom: 2px solid var(--primary-blue);
            display: flex; justify-content: space-between; align-items: center;
        }

        .logo { font-size: 22px; font-weight: bold; color: var(--primary-blue); letter-spacing: 2px; }

        main {
            display: grid; grid-template-columns: 380px 1fr 450px; gap: 15px;
            padding: 15px; flex: 1; overflow: hidden;
        }

        .column { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }

        .card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 18px; display: flex; flex-direction: column; overflow: hidden;
        }

        .card-title {
            color: var(--primary-blue); font-size: 16px; font-weight: bold;
            margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
        }

        .weather-info { background: linear-gradient(135deg, #1e293b, #0f172a); padding: 15px; border-radius: 8px; border: 1px solid #334155; }
        .temp-large { font-size: 36px; color: var(--primary-blue); font-weight: bold; }

        #chart-container { flex: 1; min-height: 180px; margin-top: 10px; }

        .status-legend {
            display: flex; gap: 20px; margin-bottom: 15px; padding: 10px;
            background: rgba(255,255,255,0.03); border-radius: 6px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; }
        .dot { width: 12px; height: 12px; border-radius: 2px; }

        .grid-wrapper { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; overflow-y: auto; }
        .panel {
            aspect-ratio: 1; border-radius: 4px; font-size: 9px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; background: rgba(255,255,255,0.05); border: 1px solid #2d3748; transition: 0.2s;
        }
        .panel:hover { border-color: #fff; transform: scale(1.05); z-index: 10; }
        .panel .p-val { font-weight: bold; margin-top: 2px; color: #fff; font-size: 10px; }

        .p-normal { border-color: var(--primary-blue); color: var(--primary-blue); }
        .p-dust { border-color: var(--warning-orange); color: var(--warning-orange); background: rgba(243,156,18,0.15); }
        .p-low { border-color: var(--sub-health); color: var(--sub-health); background: rgba(155,89,182,0.15); }
        .p-break { border-color: var(--danger-red); color: var(--danger-red); animation: pulse-blink 1.2s infinite; }

        @keyframes pulse-blink { 
            0% { background: rgba(231, 76, 60, 0.1); }
            50% { background: rgba(231, 76, 60, 0.4); border-color: #fff; }
            100% { background: rgba(231, 76, 60, 0.1); }
        }

        .device-box {
            background: rgba(255,255,255,0.03); border-radius: 6px; padding: 12px;
            margin-bottom: 10px; border-left: 4px solid var(--primary-blue); font-size: 13px;
        }
        .working { border-left-color: var(--accent-green); background: rgba(46,204,113,0.1); }
        .log-scroll-area { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; padding: 10px; color: #718096; position: sticky; top: 0; background: var(--card-bg); border-bottom: 1px solid var(--border-color); }
        td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.02); font-family: monospace; }
    </style>
</head>
<body>

<div id="alert-popup"></div>

<header>
    <div class="logo">PV-OS è¥¿åŒ—åŸºåœ°å®æ—¶è¿ç»´ä¸­å¿ƒ (V4.0)</div>
    <div id="clock" style="font-family: monospace; font-size: 18px; color: var(--primary-blue);"></div>
</header>

<main>
    <div class="column">
        <div class="card">
            <div class="card-title">è¥¿åŒ—æ°”è±¡è”ç½‘ç›‘æµ‹ (çœŸå®)</div>
            <div class="weather-info">
                <div style="display:flex; justify-content:space-between">
                    <span id="weather-city" style="color:var(--primary-blue)">è”ç½‘åŒæ­¥ä¸­...</span>
                    <span id="weather-cond" style="color:var(--warning-orange)">--</span>
                </div>
                <div style="margin:10px 0">
                    <span class="temp-large" id="weather-temp">--Â°C</span>
                    <span style="font-size:12px; color:#94a3b8; margin-left:10px">æ¹¿åº¦: <span id="weather-hum">--</span>%</span>
                </div>
                <div id="weather-tips" style="font-size:12px; border-top:1px solid #334155; padding-top:8px">æ­£åœ¨è·å–é…’æ³‰ç«™æ•°æ®...</div>
            </div>
        </div>

        <div class="card" style="flex: 1;">
            <div class="card-title">åŸºåœ°ç»´æŠ¤å•å…ƒ (å±¥å¸¦/æ— äººæœº)</div>
            <div class="device-box" id="bot-box">
                <b>BOT-A1 (å±¥å¸¦å¼æ¸…æ‰«æœºå™¨äºº)</b><br>
                çŠ¶æ€ï¼š<span id="bot-status">åŸºç«™å°±ç»ª</span>
            </div>
            <div class="device-box" style="border-left-color: var(--sub-health);">
                <b>UAV-X4 (é«˜æ¸…å·¡æ£€æ— äººæœº)</b><br>
                çŠ¶æ€ï¼š<span style="color:var(--accent-green)">åœ¨çº¿ï¼šå¯è§å…‰å·¡èˆª</span>
            </div>
            <div style="margin-top: auto; padding: 15px; background: rgba(0,242,255,0.05); border-radius: 8px;">
                <div style="font-size: 11px; color: #94a3b8;">å…¨åœºå®æ—¶æ€»åŠŸç‡ (kW)</div>
                <div id="total-power" style="font-size: 28px; font-weight: bold; color: var(--accent-green);">-- kW</div>
            </div>
        </div>
    </div>

    <div class="column" style="flex: 1.5;">
        <div class="card" style="flex: 1;">
            <div class="card-title">æ¿é˜µå¥åº·æ‹“æ‰‘ (å››çº§åŠŸç‡è¯Šæ–­)</div>
            <div class="status-legend">
                <div class="legend-item"><div class="dot" style="background:var(--primary-blue)"></div> æ­£å¸¸</div>
                <div class="legend-item"><div class="dot" style="background:var(--warning-orange)"></div> ç§¯ç°</div>
                <div class="legend-item"><div class="dot" style="background:var(--sub-health)"></div> å¼‚å¸¸</div>
                <div class="legend-item"><div class="dot" style="background:var(--danger-red)"></div> æŸå</div>
            </div>
            <div class="grid-wrapper" id="panelGrid"></div>
        </div>
    </div>

    <div class="column">
        <div class="card" style="height: 250px;">
            <div class="card-title">åŸºåœ°å®æ—¶å¹¶ç½‘åŠŸç‡æ³¢åŠ¨æ›²çº¿</div>
            <div id="chart-container">
                <canvas id="powerChart"></canvas>
            </div>
        </div>
        <div class="card" style="flex: 1;">
            <div class="card-title">è¥¿åŒ—è¿ç»´æµæ°´ (å…·ä½“æ—¶é—´æ—¥å¿—)</div>
            <div class="log-scroll-area">
                <table>
                    <thead>
                        <tr><th width="40%">æ—¥æœŸæ—¶é—´</th><th width="20%">ä¸»ä½“</th><th>è¯¦æƒ…</th></tr>
                    </thead>
                    <tbody id="logBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
    const logBody = document.getElementById('logBody');
    const clock = document.getElementById('clock');
    const panelGrid = document.getElementById('panelGrid');
    const alertPopup = document.getElementById('alert-popup');
    const totalPowerDisplay = document.getElementById('total-power');

    let powerChart;
    const powerHistory = [];
    const labelsHistory = [];
    let globalBasePower = 420; // é»˜è®¤åŸºå‡†åŠŸç‡å€¼

    function getFullDateTime() {
        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${now.toTimeString().split(' ')[0]}`;
    }
    setInterval(() => { clock.innerText = getFullDateTime(); }, 1000);

    // è·å–é«˜å¾·å¤©æ°”
    async function fetchWeather() {
        const key = '16b326717f33f898a349af7d93b703d9';
        try {
            const res = await fetch(`https://restapi.amap.com/v3/weather/weatherInfo?city=620900&key=${key}`);
            const data = await res.json();
            if(data.lives) {
                const live = data.lives[0];
                document.getElementById('weather-city').innerText = `è¥¿åŒ—ç«™ï¼š${live.city}`;
                document.getElementById('weather-cond').innerText = live.weather;
                document.getElementById('weather-temp').innerText = live.temperature + "Â°C";
                document.getElementById('weather-hum').innerText = live.humidity;
                const tips = document.getElementById('weather-tips');
                tips.innerText = live.weather.includes('å°˜') ? "ğŸš¨ æ‰¬æ²™è­¦æŠ¥ï¼šå±¥å¸¦æ¸…æ‰«è½¦è½¬å…¥é«˜é¢‘æ¸…æ‰«æ¨¡å¼ã€‚" : "âœ… æ°”è±¡è‰¯å¥½ï¼šå»ºè®®æ‰§è¡Œé«˜æ¸…æ— äººæœºå·¡æ£€ã€‚";
                addLog('ç³»ç»Ÿ', `æˆåŠŸåŒæ­¥${live.city}å¤©æ°”æ•°æ®ã€‚`);
            }
        } catch(e) {}
    }

    // [æ–°å¢] è·å– Open-Meteo å®æ—¶è¾å°„é‡
    async function fetchSolarRadiation() {
        try {
            // é…’æ³‰åŸºåœ°ç»çº¬åº¦: 39.74, 98.50
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=39.74&longitude=98.50&current=shortwave_radiation');
            const data = await res.json();
            const radiation = data.current.shortwave_radiation; // å•ä½ W/mÂ²
            
            // ç®€å•ç‰©ç†æ¨¡å‹ï¼šåŠŸç‡ = è¾å°„å€¼ * è½¬æ¢ç³»æ•° (æš‚å®š0.45)
            // è¾å°„å¼ºåº¦è¶Šå¤§ï¼ŒåŸºå‡†åŠŸç‡è¶Šé«˜
            globalBasePower = Math.max(10, radiation * 0.45); 
            
            addLog('èƒ½æºå±€', `åŒæ­¥å®æ—¶è¾å°„å¼ºåº¦ï¼š${radiation} W/mÂ² (åŠ¨æ€è°ƒæ•´åŠŸç‡åŸºå‡†)`);
            updateAllPanelsPower(); // è·å–åˆ°æ–°è¾å°„å€¼åï¼Œæ›´æ–°å…¨åœºæ¿å­æ˜¾ç¤º
        } catch(e) {
            console.error("è¾å°„APIè·å–å¤±è´¥");
        }
    }

    // åŠ¨æ€æ›´æ–°æ¿å—åŠŸç‡æ•°å€¼
    function updateAllPanelsPower() {
        document.querySelectorAll('.panel.p-normal').forEach(p => {
            const randomVar = Math.random() * 10 - 5; // Â±5W éšæœºæ‰°åŠ¨
            const newP = Math.floor(globalBasePower + randomVar);
            p.querySelector('.p-val').innerText = newP + 'W';
        });
        updateTotal();
    }

    function initChart() {
        const ctx = document.getElementById('powerChart').getContext('2d');
        powerChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelsHistory,
                datasets: [{
                    label: 'å®æ—¶åŠŸç‡ (kW)',
                    data: powerHistory,
                    borderColor: '#00f2ff',
                    backgroundColor: 'rgba(0, 242, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { display: false }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // æ¿å—åˆå§‹åŒ–
    for (let i = 1; i <= 100; i++) {
        const p = document.createElement('div');
        const id = 'P-' + String(i).padStart(3, '0');
        let power, status;

        if (i === 15 || i === 88) { power = Math.floor(Math.random()*40); status = 'p-break'; }
        else if (i % 12 === 0) { power = Math.floor(Math.random()*150 + 50); status = 'p-low'; }
        else if (i % 7 === 0) { power = Math.floor(Math.random()*150 + 200); status = 'p-dust'; }
        else { power = Math.floor(globalBasePower + (Math.random()*10 - 5)); status = 'p-normal'; }

        p.className = `panel ${status}`;
        p.innerHTML = `<span>${id}</span><span class="p-val">${power}W</span>`;
        p.onclick = () => handleAction(id, status, power, p);
        panelGrid.appendChild(p);
    }

    function handleAction(id, status, pwr, el) {
        if (status === 'p-normal') {
            addLog('å·¡æ£€', `ä¾‹è¡ŒæŠ½æ£€æ¿å— ${id}ï¼Œå½“å‰è¾“å‡ºåŠŸç‡ ${pwr}Wï¼ŒçŠ¶æ€å¥åº·ã€‚`);
            el.style.borderColor = "#fff";
            setTimeout(() => el.style.borderColor = "var(--primary-blue)", 300);
            return;
        }

        if (status === 'p-dust') {
            document.getElementById('bot-box').classList.add('working');
            document.getElementById('bot-status').innerText = `å±¥å¸¦è½¦ä½œä¸š: ${id}`;
            addLog('å±¥å¸¦è½¦', `å¼€å§‹æ¸…æ‰«ç§¯ç°æ¿å— ${id} (åŸåŠŸç‡ ${pwr}W)`);
            setTimeout(() => {
                const newP = Math.floor(globalBasePower + 12);
                el.className = 'panel p-normal';
                el.querySelector('.p-val').innerText = newP + 'W';
                document.getElementById('bot-box').classList.remove('working');
                document.getElementById('bot-status').innerText = 'åŸºç«™å¾…å‘½';
                addLog('ç³»ç»Ÿ', `æ¸…æ‰«å®Œæ¯•ï¼Œ${id} åŠŸç‡æ¢å¤æ­£å¸¸ã€‚`);
                updateTotal();
            }, 1800);
        } else if (status === 'p-low') {
            addLog('æ— äººæœº', `å¯è§å…‰è¯¦æŸ¥ ${id}ï¼šæœªå‘ç°ç‰©ç†ç ´æŸï¼Œæ¨æ–­ä¸ºå±€éƒ¨é˜´å½±é®æŒ¡ã€‚`);
        } else if (status === 'p-break') {
            alertPopup.innerHTML = `ğŸš¨ <b>ç¡¬ä»¶ä¸¥é‡æŸåå‘Šè­¦</b><br>ç¼–å·ï¼š#${id}<br>è¯Šæ–­ï¼š<b>ç‰©ç†ç¢è£‚ / æ±‡æµç«¯çƒ§æ¯</b><br>åŠŸç‡ï¼š${pwr}W<br>è¯·ç«‹å³é€šçŸ¥è¥¿åŒ—åŸºåœ°æ£€ä¿®ç»„å‰å¾€ã€‚`;
            alertPopup.style.display = 'block';
            addLog('è­¦æŠ¥', `[ä¸¥é‡æ•…éšœ] æ¿å— ${id} åŠŸç‡æ‰çº¿ï¼Œéœ€æ›´æ¢ç¡¬ä»¶ã€‚`);
            setTimeout(() => alertPopup.style.display='none', 5000);
        }
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.p-val').forEach(v => total += parseInt(v.innerText));
        const finalKW = (total / 1000).toFixed(2);
        totalPowerDisplay.innerText = finalKW + " kW";
        
        const timeLabel = new Date().toLocaleTimeString();
        labelsHistory.push(timeLabel);
        powerHistory.push(finalKW);
        if(labelsHistory.length > 20) { labelsHistory.shift(); powerHistory.shift(); }
        if(powerChart) powerChart.update();
    }

    function addLog(obj, msg) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${getFullDateTime()}</td><td style="color:var(--primary-blue)">${obj}</td><td>${msg}</td>`;
        logBody.insertBefore(tr, logBody.firstChild);
    }

    initChart();
    fetchWeather();
    fetchSolarRadiation(); 
    setInterval(fetchSolarRadiation, 30000); // æ¯30ç§’åŒæ­¥ä¸€æ¬¡çœŸå®è¾å°„å€¼
    setInterval(updateTotal, 3000); 
</script>
</body>
</html>

